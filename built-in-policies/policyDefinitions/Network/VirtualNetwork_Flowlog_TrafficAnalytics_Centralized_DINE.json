{
  "properties": {
    "displayName": "Deploy VNet Flow Logs with Traffic Analytics for VNets with regional Storage and centralized Log Analytics",
    "description": "Deploy VNet Flow Logs with Traffic Analytics for VNets with regional Storage and centralized Log Analytics. Before remediation ensure that the resourceGroupName Resource Group, Storage Account, Log Analytics Workspace, Network Watcher are all deployed already.",
    "policyType": "BuiltIn",
    "mode": "Indexed",
    "metadata": {
      "version": "1.0.0",
      "category": "Network"
    },
    "version": "1.0.0",
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "retentionDays": {
        "type": "String",
        "metadata": {
          "displayName": "Number of days to retain flow logs",
          "description": "The number of days for which flowlog data will be retained in storage account. If you want to retain data forever and do not want to apply any retention policy, set retention (days) to 0."
        },
        "defaultValue": "0"
      },
      "timeIntervalInMins": {
        "type": "String",
        "metadata": {
          "displayName": "Traffic Analytics Interval (min)",
          "description": "Traffic analytics processes blobs at the selected frequency."
        },
        "allowedValues": [
          "10",
          "60"
        ],
        "defaultValue": "60"
      },
      "workspaceRegion": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace Region",
          "description": "Region for Log Analytics workspace.",
          "strongType": "location"
        },
        "defaultValue": "eastus"
      },
      "resourceGroupName": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Group",
          "description": "Resource group where the Storage Account and Log Analytics Workspace exists"
        }
      },
      "updateFlowlog": {
        "type": "String",
        "metadata": {
          "displayName": "Update the Storage account and Log Analytics for existing vnet flowlogs",
          "description": "Set as true if the existing VNet flowlogs also need to be updated with created regional Storage account and Log Analytics workspace."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/virtualNetworks"
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/networkWatchers/flowLogs",
          "name": "[if(empty(coalesce(field('Microsoft.Network/virtualNetworks/flowLogs[*].id'))), 'null/null', concat(split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[8], '/', split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[10]))]",
          "resourceGroupName": "[if(empty(coalesce(field('Microsoft.Network/virtualNetworks/flowLogs'))), 'NetworkWatcherRG', split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[4])]",
          "existenceCondition": {
            "anyOf": [
              {
                "field": "Microsoft.Network/networkWatchers/flowLogs/enabled",
                "equals": "false"
              },
              {
                "allOf": [
                  {
                    "field": "Microsoft.Network/networkWatchers/flowLogs/enabled",
                    "equals": "true"
                  },
                  {
                    "field": "Microsoft.Network/networkWatchers/flowLogs/flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.enabled",
                    "equals": "true"
                  },
                  {
                    "field": "Microsoft.Network/networkWatchers/flowLogs/flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.trafficAnalyticsInterval",
                    "in": [
                      "10",
                      "60"
                    ]
                  },
                  {
                    "anyOf": [
                      {
                        "value": "[parameters('UpdateFlowlog')]",
                        "equals": false
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Network/networkWatchers/flowLogs/storageId",
                            "equals": "[toLower(concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', if(equals(parameters('resourceGroupName'), 'nwtarg'), concat('nwtarg-', subscription().subscriptionId), parameters('resourceGroupName')), '/providers/Microsoft.Storage/storageAccounts/', toLower(concat('nwtasa', uniqueString(concat(subscription().subscriptionId, field('location')))))))"
                          },
                          {
                            "field": "Microsoft.Network/networkWatchers/flowLogs/flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.workspaceResourceId",
                            "equals": "[toLower(concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', if(equals(parameters('resourceGroupName'), 'nwtarg'), concat('nwtarg-', subscription().subscriptionId), parameters('resourceGroupName')), '/providers/Microsoft.OperationalInsights/workspaces/', toLower(concat('nwtaws', uniqueString(concat(subscription().subscriptionId, parameters('workspaceRegion')))))))"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "workspaceRegion": {
                    "type": "String"
                  },
                  "retentionDays": {
                    "type": "String"
                  },
                  "timeIntervalInMins": {
                    "type": "String"
                  },
                  "networkWatcherRG": {
                    "type": "String"
                  },
                  "networkWatcherName": {
                    "type": "String"
                  },
                  "flowlogName": {
                    "type": "String"
                  },
                  "resourceGroupName": {
                    "type": "String"
                  },
                  "targetVnetId": {
                    "type": "String"
                  },
                  "updateFlowlog": {
                    "type": "String"
                  }
                },
                "variables": {
                  "resourceGroupName": "[if(equals(parameters('resourceGroupName'), 'nwtarg'), concat('nwtarg-', subscription().subscriptionId), parameters('resourceGroupName'))]",
                  "storageAccountName": "[toLower(concat('nwtasa', uniqueString(concat(subscription().subscriptionId, field('location')))))]",
                  "storageAccountResourceId": "[resourceId(subscription().subscriptionId, variables('resourceGroupName'), 'Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                  "workspaceName": "[toLower(concat('nwtaws', uniqueString(concat(subscription().subscriptionId, parameters('workspaceRegion')))))]",
                  "workspaceResourceId": "[resourceId(subscription().subscriptionId, variables('resourceGroupName'), 'Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2021-04-01",
                    "name": "[concat('deployFlowLogToNetworkWatcherRG', uniqueString(concat(subscription().subscriptionId, field('location'))))]",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "resources": [
                          {
                            "condition": "[and(not(empty(reference(variables('storageAccountResourceId'), '2021-09-01').primaryEndpoints)), not(empty(reference(variables('workspaceResourceId'), '2021-06-01').customerId)))]",
                            "type": "Microsoft.Network/networkWatchers/flowLogs",
                            "apiVersion": "2022-09-01",
                            "name": "[concat(parameters('networkWatcherName'), '/', parameters('flowlogName'))]",
                            "location": "[field('location')]",
                            "properties": {
                              "enabled": true,
                              "targetResourceId": "[parameters('targetVnetId')]",
                              "storageId": "[variables('storageAccountResourceId')]",
                              "flowAnalyticsConfiguration": {
                                "networkWatcherFlowAnalyticsConfiguration": {
                                  "enabled": true,
                                  "workspaceResourceId": "[variables('workspaceResourceId')]",
                                  "workspaceRegion": "[parameters('workspaceRegion')]",
                                  "trafficAnalyticsInterval": "[parameters('timeIntervalInMins')]"
                                }
                              },
                              "retentionPolicy": {
                                "days": "[parameters('retentionDays')]",
                                "enabled": true
                              },
                              "format": {
                                "type": "JSON",
                                "version": 2
                              }
                            }
                          }
                        ]
                      }
                    },
                    "resourceGroup": "[parameters('networkWatcherRG')]"
                  }
                ]
              },
              "parameters": {
                "workspaceRegion": {
                  "value": "[parameters('workspaceRegion')]"
                },
                "retentionDays": {
                  "value": "[parameters('retentionDays')]"
                },
                "timeIntervalInMins": {
                  "value": "[parameters('timeIntervalInMins')]"
                },
                "networkWatcherRG": {
                  "value": "[if(empty(coalesce(field('Microsoft.Network/virtualNetworks/flowLogs'))), 'NetworkWatcherRG', split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[4])]"
                },
                "networkWatcherName": {
                  "value": "[if(empty(coalesce(field('Microsoft.Network/virtualNetworks/flowLogs'))), concat('NetworkWatcher_', field('location')), split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[8])]"
                },
                "flowlogName": {
                  "value": "[if(empty(coalesce(field('Microsoft.Network/virtualNetworks/flowLogs'))), concat(take(concat(field('name'), '-', resourceGroup().name), 72), '-', 'flowlog'), split(first(field('Microsoft.Network/virtualNetworks/flowLogs[*].id')), '/')[10])]"
                },
                "resourceGroupName": {
                  "value": "[parameters('resourceGroupName')]"
                },
                "targetVnetId": {
                  "value": "[concat(resourceGroup().id, '/providers/Microsoft.Network/virtualNetworks/', field('name'))]"
                },
                "updateFlowlog": {
                  "value": "[parameters('updateFlowlog')]"
                }
              }
            }
          }
        }
      }
    },
    "versions": [
      "1.0.0"
    ]
  },
  "id": "/providers/Microsoft.Authorization/policyDefinitions/6d7c9ba4-b4b9-4d38-9e86-f1bc6b322bde",
  "name": "6d7c9ba4-b4b9-4d38-9e86-f1bc6b322bde"
}